<html>
	<head>
		<title>PAWS-OIDC-bridge Test Page</title>
		<!--<script src="oidc-client.js"></script>-->
		<!--<script>if( typeof PAWS_OIDC_bridge === "undefined" ) { PAWS_OIDC_bridge = {}; } PAWS_OIDC_bridge.AUTOLOGIN = false</script>-->
		<!--<script src="PAWS-OIDC-bridge.js"></script>-->
	</head>
	<body>
		<h1>PAWS-OIDC-bridge Test Page</h1>
		<div>
			<p>
				<button onclick="PAWS_OIDC_bridge.login()">Silent Login</button>
				<span>Happens automatically when loaded (run again to re-test after logout)</span>
			</p><p>
				<button onclick="PAWS_OIDC_bridge.logout( (data)=>{alert(data.failure?'Logout Failed! -- '+data.error.message:'Logout Succeed');} )">Silent Logout</button>
				<span>PAWS should do this before its own logout</span>
			</p>
			</p><p>
				<button onclick="PAWS_OIDC_bridge.popup_login()">Popup Login</button>
				<span>PAWS should not do this (for testing only)</span>
			</p>
			<br/>
			<div id="PAWS-OIDC-bridge-status"></div>
		</div>
		<!--<script>PAWS_OIDC_bridge.login()</script>-->
		<!--<script>PAWS_OIDC_bridge.await_prop( "ENV", () => { PAWS_OIDC_bridge.ENV.origin = location.protocol + "//" + location.host } );</script>-->
		<script>
			let next = window;
			let depth = 0;
			while( next.parent !== next ) {
				next = next.parent;
				depth += 1;
			}
			let fn = depth+">index";
			loadscript = function(url,callback) {
				let fn = depth+">index/loadscript";
				console.log( fn+": loading ", url );
				let tag = document.createElement("script");
				tag.setAttribute("src",url+"?"+(new Date()).toISOString())
				tag.onload = function() {
					console.log( fn+": loaded", url );
					document.head.removeChild(tag);
					if(callback) { callback(); }
				};
				document.head.appendChild(tag);
			};
			await = function( desc, test, callback, delay=0 ) {
				let fn = depth+">index/await";
				let step = 100;
				try {
					result = test();
					if( ! result ) {
						console.log( fn+": ", desc, delay, " falsey result -- ", result );
						delay += step;
						setTimeout( () => await(desc,test,callback,delay), step );
					} else {
						console.log( fn+": ", desc, delay, " truthy result -- ", result );
						callback();
					}
				} catch(e) {
					console.log( fn+": ", desc, delay, " error result -- ", result );
					delay += step;
					setTimeout( () => await(desc,test,callback,delay), step );
				}
			}
			loadscript( "PAWS-OIDC-bridge-env.js", () => {
				await(
					"origin",
					() => { return typeof PAWS_OIDC_bridge.ENV.loginSettings.origin !== "undefined" },
					() => { 
						console.log( fn+": origin = ", PAWS_OIDC_bridge.ENV.loginSettings.origin );
						let realOrigin = location.protocol + "//" + location.host;
						if( realOrigin != PAWS_OIDC_bridge.ENV.loginSettings.origin ) {
							console.warn( fn+": Overriding Origin" );
							PAWS_OIDC_bridge.ENV.loginSettings.origin = realOrigin;
							PAWS_OIDC_bridge.ENV.loginSettings.redirect_uri += "?origin="+realOrigin;
							PAWS_OIDC_bridge.ENV.loginSettings.silent_redirect_uri += "?origin="+realOrigin;
							PAWS_OIDC_bridge.ENV.loginSettings.popup_redirect_uri += "?origin="+realOrigin;
							PAWS_OIDC_bridge.ENV.loginSettings.post_logout_redirect_uri += "?origin="+realOrigin;
							console.log( fn+": origin = ", PAWS_OIDC_bridge.ENV.loginSettings.origin );
							console.log( fn+": settings = ", PAWS_OIDC_bridge.ENV.loginSettings );
						} else {
							console.warn( fn+": Keeping Default Origin" );
						}
						loadscript( "PAWS-OIDC-bridge.js" );
					}
				);
			} );
		</script>
	</body>
</html>
